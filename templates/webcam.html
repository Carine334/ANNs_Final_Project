<!DOCTYPE html>
<html>
<head>
    <title>Webcam Image Capture</title>
</head>
<body>
    <div id="container">
        <div id="header">
            <h1>Webcam Image Capture</h1>
        </div>
        <div id="content">
            <canvas id="image-preview" width="640" height="480"></canvas>
            <div id="controls">
                <video id="video-preview" width="640" height="480" autoplay></video>
                <button id="capture-button" disabled>Capture Last Frame</button>
            </div>
            <div id="prediction-result">
                <!-- Prediction result will be displayed here -->
            </div>
            <div id="grad-cam">
                <!-- Grad-CAM visualization will be displayed here -->
            </div>
        </div>
        <div id="footer">
            <p>ANNs Winter Semester 2023/2024</p>
        </div>
    </div>
    
    <script>
        // Get video element
        const videoPreview = document.getElementById('video-preview');
        
        // Get capture button
        const captureButton = document.getElementById('capture-button');
        
        // Variables to hold media stream and image capture capabilities
        let mediaStream;
        let imageCapture;
        
        // Function to initialize media stream and image capture
        async function initializeMediaStreamAndImageCapture() {
            try {
                // Get media stream
                mediaStream = await navigator.mediaDevices.getUserMedia({ video: true });
                
                // Display media stream in video element
                videoPreview.srcObject = mediaStream;
                
                // Get image capture capabilities from media stream
                const track = mediaStream.getVideoTracks()[0];
                imageCapture = new ImageCapture(track);
                
                // Enable capture button
                captureButton.disabled = false;
            } catch (error) {
                console.error('Error accessing webcam:', error);
                alert('Error accessing webcam. Please ensure it is not blocked by your browser.');
            }
        }
        
        // Function to capture a picture
        async function capturePicture() {
            try {
                // Capture picture
                const blob = await imageCapture.takePhoto();
                
                // Display captured picture
                const canvas = document.getElementById('image-preview');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.onload = function() {
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    sendImage(blob);
                }
                img.src = URL.createObjectURL(blob);
                
                // Stop video stream
                mediaStream.getVideoTracks()[0].stop();
                
                // Remove video preview element
                videoPreview.remove();
                
                // Disable capture button
                captureButton.disabled = true;
            } catch (error) {
                console.error('Error capturing picture:', error);
                alert('Error capturing picture. Please try again.');
            }
        }
        
        // Function to send the captured image to the server for processing
        async function sendImage(imageBlob) {
            try {
                // Create FormData object
                const formData = new FormData();
                formData.append('file', imageBlob, 'webcam_image.jpg');
                
                // Send POST request to the server
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                // Get prediction result from the response
                const result = await response.json();
                
                // Display prediction result
                const predictionResult = document.getElementById('prediction-result');
                predictionResult.innerHTML = `<h3>This image refers to a ${result.name_class} sign with a confidence of ${result.confidence_level}</h3>`;
                
                // Display Grad-CAM visualization if available
                if (result.grad_cam) {
                    const gradCamDiv = document.getElementById('grad-cam');
                    const gradCamImg = new Image();
                    gradCamImg.src = 'data:image/jpeg;base64,' + result.grad_cam;
                    gradCamDiv.innerHTML = '';
                    gradCamDiv.appendChild(gradCamImg);
                }
            } catch (error) {
                console.error('Error sending image to server:', error);
                alert('Error sending image to server. Please try again.');
            }
        }
        
        // Event listener for capture button
        captureButton.addEventListener('click', capturePicture);
        
        // Initialize media stream and image capture when the script is executed
        initializeMediaStreamAndImageCapture();
    </script>
</body>
</html>
